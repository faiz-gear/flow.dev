# Story 1.3: GitHub OAuth Connection

## Status
Done

## Story
**As an** authenticated User,
**I want** to connect my GitHub account via a secure OAuth flow,
**so that** `flow.dev` can access my repository data.

## Acceptance Criteria
1. The dashboard page displays a "Connect GitHub" button.
2. Clicking the button initiates the standard GitHub OAuth2 flow, requesting **read-only** permissions.
3. Upon successful authorization, the application securely stores the GitHub OAuth token associated with the user's account.
4. The dashboard UI updates to show a "Connected" status for GitHub.
5. The OAuth flow handles failure and cancellation gracefully, returning the user to the dashboard with an appropriate message.

## Tasks / Subtasks
- [x] Set up GitHub OAuth App configuration (AC: 2)
  - [x] Create GitHub OAuth application with appropriate callback URLs
  - [x] Configure environment variables for GitHub OAuth (CLIENT_ID, CLIENT_SECRET)
  - [x] Set permissions to read-only for repositories and pull requests
- [x] Create GitHub OAuth service utility (AC: 2, 3)
  - [x] Create `/apps/web/src/app/utils/github/oauth.ts` for OAuth flow management
  - [x] Implement OAuth URL generation with proper scopes and state parameter
  - [x] Add token exchange functionality for authorization code
  - [x] Add token encryption/decryption utilities for secure storage
- [x] Update dashboard page with GitHub connection UI (AC: 1, 4)
  - [x] Add "Connect GitHub" button to `/apps/web/src/app/dashboard/page.tsx`
  - [x] Display GitHub connection status based on token presence
  - [x] Style components using HeroUI and Tailwind CSS v4
  - [x] Add conditional rendering for connected/disconnected states
- [x] Implement OAuth callback API route (AC: 3, 5)
  - [x] Create `/apps/web/src/app/api/auth/github/callback/route.ts`
  - [x] Handle authorization code exchange for access token
  - [x] Encrypt and store GitHub token in user_profiles table
  - [x] Handle OAuth errors and cancellation scenarios
  - [x] Redirect back to dashboard with success/error status
- [x] Update database schema and types (AC: 3)
  - [x] Ensure `github_token_encrypted` field exists in user_profiles table
  - [x] Update TypeScript interfaces to include GitHub token field
  - [x] Create database utility functions for token storage/retrieval
- [x] Add OAuth initiation logic (AC: 2)
  - [x] Implement button click handler to redirect to GitHub OAuth
  - [x] Generate secure state parameter for CSRF protection
  - [x] Store state in session for validation on callback
- [x] Implement error handling and user feedback (AC: 5)
  - [x] Handle network errors during OAuth flow
  - [x] Display user-friendly error messages using HeroUI Toast/Alert
  - [x] Provide retry mechanism for failed connections
  - [x] Log OAuth errors for debugging purposes
- [x] Write unit tests for OAuth utilities
  - [x] Test OAuth URL generation with proper parameters
  - [x] Test token encryption/decryption functions
  - [x] Test state parameter generation and validation
  - [x] Test error handling scenarios
- [x] Write integration tests for OAuth flow
  - [x] Test complete OAuth flow using Playwright
  - [x] Test error scenarios (cancellation, invalid state)
  - [x] Test dashboard UI updates after successful connection
  - [x] Test token storage and retrieval functionality

## Dev Notes

### Previous Story Insights
From Story 1.2 implementation:
- Dashboard page exists at `/apps/web/src/app/dashboard/page.tsx` with auth protection
- Supabase client utilities configured in `/apps/web/src/app/utils/supabase/`
- User authentication working with @supabase/ssr v0.3.0
- HeroUI components integrated and styled with Tailwind CSS v4
- Auth session middleware configured in `/apps/web/src/middleware.ts`

### Project Structure
All new code for this story goes in `apps/web/` directory [Source: architecture/10-unified-project-structure.md]:
- OAuth utilities: `/apps/web/src/app/utils/github/`
- API routes: `/apps/web/src/app/api/auth/github/callback/`
- Dashboard updates: `/apps/web/src/app/dashboard/page.tsx`
- Environment variables: `/apps/web/.env.local`

### Tech Stack Requirements
Must use these exact versions [Source: architecture/3-tech-stack.md#technology-stack-table]:
- Next.js: 14.2.3 (already configured, use App Router)
- Supabase: 1.165.0 (for token storage)
- @supabase/ssr: 0.3.0 (for server-side operations)
- HeroUI: 2.1.1 (for UI components)
- Tailwind CSS: 3.4.3 (for styling)

### Data Models
UserProfile model must include GitHub token field [Source: architecture/4-data-models.md#user-profile]:
```typescript
export interface UserProfile {
  id: string; // UUID - references auth.users(id)
  updated_at: string; // ISO 8601 timestamp
  report_email: string | null;
  github_token_encrypted?: string | null; // Added for this story
}
```

### Database Schema
The app.user_profiles table includes GitHub token storage [Source: architecture/9-database-schema.md]:
```sql
CREATE TABLE app.user_profiles (
    id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    updated_at timestamptz DEFAULT now(),
    report_email text,
    github_token_encrypted text  -- This field stores the encrypted OAuth token
);
```

### GitHub API Integration
OAuth configuration details [Source: architecture/7-external-apis.md#github-api]:
- **Purpose**: To fetch repository and pull request data for analysis
- **Authentication**: OAuth 2.0 (read-only permissions)
- **Documentation**: https://docs.github.com/en/rest
- **Required Scopes**: `repo:status`, `public_repo` (read-only access to repositories)

### Core Workflow
User onboarding workflow from architecture [Source: architecture/8-core-workflows.md#user-onboarding-github-connection]:
1. User visits dashboard (previous stories completed)
2. User clicks "Connect GitHub" button (this story)
3. Next.js App redirects to GitHub OAuth
4. User authorizes application on GitHub
5. GitHub redirects to callback API with authorization code
6. Callback API exchanges code for access token
7. Next.js App encrypts and saves token to Supabase
8. User redirected back to dashboard with success confirmation

### Component Specifications
Frontend components from architecture [Source: architecture/6-components.md#frontend-components]:
- **GitHubConnector**: Provides the UI for initiating the GitHub OAuth connection
  - This story implements the GitHubConnector component
  - Use HeroUI Button component for "Connect GitHub" action
  - Display connection status with appropriate visual feedback
  - Handle loading states during OAuth flow

### Security Considerations
- Store GitHub tokens encrypted in database for security
- Use CSRF protection with state parameter in OAuth flow
- Validate state parameter on callback to prevent attacks
- Use HTTPS for all OAuth redirects in production
- Store tokens server-side only, never expose in client JavaScript

### Testing Requirements
Based on tech stack [Source: architecture/3-tech-stack.md]:
- Unit Testing: Jest & React Testing Library (29.7.0)
- Integration Testing: Playwright (1.44.0)
- Test OAuth flow end-to-end including error scenarios
- Test token encryption/decryption functionality
- Test database operations for token storage
- Mock GitHub API responses for testing

### Testing Standards
- Place unit tests next to utilities (e.g., `oauth.test.ts`)
- Place integration tests in `apps/web/tests/` directory
- Use Jest for utility function testing
- Use Playwright for full OAuth flow testing
- Test both success and failure scenarios
- Ensure tests work with mocked GitHub responses

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-23 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- OAuth utility unit tests: all 26 tests passing
- Integration tests created for end-to-end OAuth flow testing

### Completion Notes List
- ✅ All tasks and subtasks completed successfully
- ✅ GitHub OAuth configuration added to environment variables
- ✅ Complete OAuth service utility with encryption/decryption
- ✅ Dashboard UI updated with GitHubConnector component
- ✅ OAuth callback API route handles all success/error scenarios
- ✅ Database schema and TypeScript types updated for GitHub token
- ✅ OAuth initiation logic with CSRF state protection
- ✅ Comprehensive error handling with user-friendly messages
- ✅ Unit tests covering all OAuth utility functions (26 tests passing)
- ✅ Integration tests for complete OAuth flow using Playwright

### File List
#### New Files Created:
- `/apps/web/src/app/utils/github/oauth.ts` - Core OAuth utilities
- `/apps/web/src/app/utils/database/profiles.ts` - Database utility functions
- `/apps/web/src/app/types/database.ts` - TypeScript type definitions
- `/apps/web/src/app/dashboard/components/GitHubConnector.tsx` - OAuth UI component
- `/apps/web/src/app/dashboard/components/NotificationHandler.tsx` - Success/error notifications
- `/apps/web/src/app/api/auth/github/callback/route.ts` - OAuth callback API
- `/apps/web/src/app/api/auth/github/disconnect/route.ts` - Disconnect API
- `/apps/web/src/app/utils/github/__tests__/oauth.test.ts` - Unit tests (26 tests)
- `/apps/web/src/app/dashboard/components/__tests__/GitHubConnector.test.tsx` - Component tests
- `/apps/web/tests/e2e/github-oauth.spec.ts` - Integration tests

#### Modified Files:
- `/apps/web/src/app/dashboard/page.tsx` - Added GitHub connection UI
- `/apps/web/.env.local` - Added GitHub OAuth environment variables
- `/apps/web/.env.example` - Updated with GitHub OAuth variables

## QA Results
_This section will be populated by the QA agent during review_